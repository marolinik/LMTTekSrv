# Render.com Deployment Guide
# LM TEK Server Configurator

**Last Updated:** 2025-10-29
**Version:** 1.1.0

---

## Overview

This guide covers deploying the LM TEK Server Configurator to Render.com using their Blueprint (Infrastructure as Code) feature.

**Services Created:**
- PostgreSQL Database (lmtek-postgres)
- Node.js Backend API (lmtek-backend)
- React Frontend Static Site (lmtek-frontend)

---

## Prerequisites

- [x] GitHub account
- [x] Render.com account (sign up at https://render.com)
- [x] Repository pushed to GitHub: https://github.com/marolinik/LMTTekSrv
- [x] Strong admin password generated (see Security section)

---

## Deployment Steps

### Step 1: Prepare Secrets

Before deploying, prepare these values (**DO NOT commit to Git**):

1. **Generate Strong Admin Password:**
   ```bash
   # On Linux/Mac:
   openssl rand -base64 32

   # Or use a password manager to generate 20+ character password
   ```

2. **Save These Values** (you'll need them in Step 4):
   - Admin Email: `admin@lmtek.com`
   - Admin Password: `[YOUR-STRONG-PASSWORD-HERE]`
   - Keep these in a secure password manager

---

### Step 2: Create Render Account

1. Go to https://render.com
2. Click "Get Started for Free"
3. Sign up with your GitHub account
4. Authorize Render to access your repositories

---

### Step 3: Deploy Blueprint

1. In Render Dashboard, click **"New +"** → **"Blueprint"**

2. **Connect Repository:**
   - Select: `marolinik/LMTTekSrv`
   - Branch: `main`
   - Click "Connect"

3. **Review Services:**
   Render will read `render.yaml` and show:
   ```
   ✓ Database: lmtek-postgres (PostgreSQL)
   ✓ Web Service: lmtek-backend (Node.js)
   ✓ Static Site: lmtek-frontend (React/Vite)
   ```

4. **Don't click "Apply" yet** - we need to set environment variables first

---

### Step 4: Configure Environment Variables

**IMPORTANT:** Set these before deploying!

#### Backend Service (lmtek-backend)

Click on "lmtek-backend" service, then "Environment" tab:

| Variable | Value | Notes |
|----------|-------|-------|
| `ALLOWED_ORIGINS` | `https://lmtek-frontend.onrender.com` | Update after getting actual URL |
| `ADMIN_EMAIL` | `admin@lmtek.com` | Or your preferred admin email |
| `ADMIN_PASSWORD` | `[YOUR-STRONG-PASSWORD]` | From Step 1 |
| `DATABASE_URL` | *Auto-set by Render* | Don't change |
| `JWT_SECRET` | *Auto-generated by Render* | Don't change |

#### Frontend Service (lmtek-frontend)

Click on "lmtek-frontend" service, then "Environment" tab:

| Variable | Value | Notes |
|----------|-------|-------|
| `VITE_API_URL` | `https://lmtek-backend.onrender.com/api` | Update after getting actual URL |
| `VITE_GEMINI_API_KEY` | `[YOUR-API-KEY]` | Optional: Only if using AI features |

**Note:** You'll need to update these URLs after deployment completes and you get the actual Render URLs.

---

### Step 5: Deploy

1. Click **"Apply"** to create all services
2. Wait for deployment (5-10 minutes)
3. Monitor the deployment logs for each service

**Deployment Order:**
1. Database deploys first (~2 min)
2. Backend deploys (~5 min) - includes Prisma setup
3. Frontend deploys (~3 min) - builds React app

---

### Step 6: Run Database Migrations

After backend deploys successfully:

1. Go to **lmtek-backend** service
2. Click **"Shell"** tab (opens terminal)
3. Run database migrations:
   ```bash
   cd server
   npx prisma migrate deploy
   ```

4. Seed the database with initial data:
   ```bash
   node prisma/seed.prod.js
   ```

5. Verify success - you should see:
   ```
   ✓ Database migrations applied
   ✓ Seed data inserted
   ```

---

### Step 7: Update CORS Settings

After deployment, you'll get actual URLs like:
- Frontend: `https://lmtek-frontend-xxxx.onrender.com`
- Backend: `https://lmtek-backend-yyyy.onrender.com`

**Update Backend Environment Variables:**

1. Go to **lmtek-backend** → **Environment**
2. Update `ALLOWED_ORIGINS`:
   ```
   https://lmtek-frontend-xxxx.onrender.com
   ```
   (Replace `xxxx` with your actual Render subdomain)

3. Click **"Save Changes"**
4. Service will auto-redeploy (~2 min)

**Update Frontend Environment Variables:**

1. Go to **lmtek-frontend** → **Environment**
2. Update `VITE_API_URL`:
   ```
   https://lmtek-backend-yyyy.onrender.com/api
   ```
   (Replace `yyyy` with your actual Render subdomain)

3. Click **"Save Changes"**
4. Service will auto-redeploy (~2 min)

---

### Step 8: Verify Deployment

#### Test Backend API

```bash
# Health check
curl https://lmtek-backend-[YOUR-ID].onrender.com/api/health

# Expected response:
# {"status":"ok","timestamp":"2025-10-29T...","environment":"production"}
```

#### Test Frontend

1. Open: `https://lmtek-frontend-[YOUR-ID].onrender.com`
2. Should see the login page
3. Login with admin credentials (from Step 1)
4. Verify:
   - [x] Components load in configurator
   - [x] Can create quotes
   - [x] Admin dashboard accessible
   - [x] All 11 component categories visible

#### Check Logs

If anything fails:

1. **Backend Logs:**
   - lmtek-backend → Logs tab
   - Look for errors in startup or requests

2. **Frontend Logs:**
   - lmtek-frontend → Logs tab
   - Check build process completed

3. **Database Logs:**
   - lmtek-postgres → Logs tab
   - Verify migrations ran

---

## Custom Domain Setup (Optional)

### For Frontend

1. Go to **lmtek-frontend** → **Settings** → **Custom Domain**
2. Click **"Add Custom Domain"**
3. Enter: `www.lmtek-configurator.com` (or your domain)
4. Update DNS records as instructed by Render:
   ```
   Type: CNAME
   Name: www
   Value: lmtek-frontend-xxxx.onrender.com
   ```
5. Wait for DNS propagation (5-60 minutes)
6. SSL certificate auto-provisions

### For Backend API

1. Go to **lmtek-backend** → **Settings** → **Custom Domain**
2. Click **"Add Custom Domain"**
3. Enter: `api.lmtek-configurator.com`
4. Update DNS:
   ```
   Type: CNAME
   Name: api
   Value: lmtek-backend-yyyy.onrender.com
   ```

### Update CORS After Custom Domain

1. Go to **lmtek-backend** → **Environment**
2. Update `ALLOWED_ORIGINS` to include custom domain:
   ```
   https://www.lmtek-configurator.com,https://lmtek-frontend-xxxx.onrender.com
   ```
3. Update **lmtek-frontend** → **Environment** → `VITE_API_URL`:
   ```
   https://api.lmtek-configurator.com/api
   ```

---

## Automatic Deployments

### How It Works

- **Push to main branch** → Automatic deployment to production
- **Pull requests** → Can create preview environments
- **Manual deploys** → Available via Render Dashboard

### Disable Auto-Deploy (Optional)

If you want manual control:

1. Go to service → **Settings**
2. Find **"Auto-Deploy"**
3. Toggle to **Off**
4. Deploy manually via **"Manual Deploy"** button

---

## Monitoring & Maintenance

### View Metrics

Each service has a **"Metrics"** tab showing:
- CPU usage
- Memory usage
- Request rate
- Response time
- Error rate

### Set Up Alerts

1. Go to service → **Notifications**
2. Click **"Add Notification"**
3. Configure:
   - Event: Deploy failed / Service unhealthy
   - Channel: Email / Slack / Discord
   - Email: your@email.com

### Database Backups

**Automatic Backups** (Starter plan and above):
- Daily backups retained for 7 days
- View in **lmtek-postgres** → **Backups**

**Manual Backup:**
1. Go to **lmtek-backend** → **Shell**
2. Run:
   ```bash
   pg_dump $DATABASE_URL > backup_$(date +%Y%m%d).sql
   ```

---

## Cost Breakdown

### Free Tier (Testing Only)

| Service | Free Tier | Limitations |
|---------|-----------|-------------|
| Database | ❌ Not available | Must use paid plan |
| Backend | 750 hours/month | Spins down after 15min inactivity |
| Frontend | ✅ Free forever | No limitations |

**Free Tier Issues:**
- Services spin down after inactivity (30-50s cold start)
- Database requires paid plan
- Not suitable for production

### Starter Plan (Recommended)

| Service | Monthly Cost | Features |
|---------|--------------|----------|
| Database (Starter) | $7 | 1GB storage, always-on |
| Backend (Starter) | $7 | 512MB RAM, always-on |
| Frontend (Static) | $0 | Free, served via CDN |
| **Total** | **$14/month** | Production-ready |

### Standard Plan

| Service | Monthly Cost | Features |
|---------|--------------|----------|
| Database (Standard) | $20 | 10GB storage, 2GB RAM |
| Backend (Standard) | $25 | 2GB RAM, faster CPU |
| **Total** | **$45/month** | Higher performance |

**Recommendation:** Start with Starter plan ($14/month), upgrade if needed.

---

## Security Checklist

Before going live:

### Required (Critical)
- [ ] Changed default admin password to strong unique value
- [ ] Admin password NOT committed to Git
- [ ] JWT_SECRET auto-generated by Render (don't share)
- [ ] HTTPS enabled (automatic on Render)
- [ ] CORS configured with exact frontend URL
- [ ] Environment variables set via Render Dashboard (not in code)

### Recommended (High Priority)
- [ ] Implemented rate limiting (see SECURITY_ROADMAP.md)
- [ ] Moved JWT to httpOnly cookies (see SECURITY_ROADMAP.md)
- [ ] Input sanitization enabled (see SECURITY_ROADMAP.md)
- [ ] Monitoring alerts configured
- [ ] Database backups enabled

### Optional (Best Practices)
- [ ] Custom domain with SSL
- [ ] Content Security Policy headers
- [ ] 2FA enabled on Render account
- [ ] Error tracking (Sentry)
- [ ] Log retention policy

**See `SECURITY_ROADMAP.md` for complete security implementation guide.**

---

## Troubleshooting

### Issue: Backend Won't Start

**Symptoms:**
```
Error: Can't reach database server
```

**Solutions:**
1. Check `DATABASE_URL` is set (should be auto-set)
2. Verify database service is running
3. Check migrations ran successfully:
   ```bash
   cd server && npx prisma migrate deploy
   ```

### Issue: Frontend Shows 404

**Symptoms:**
- Frontend loads but API requests fail
- Console shows CORS errors

**Solutions:**
1. Verify `VITE_API_URL` is correct in frontend env vars
2. Check backend is running (visit health endpoint)
3. Update `ALLOWED_ORIGINS` in backend to match frontend URL exactly
4. Ensure URLs include `https://` (no trailing slash)

### Issue: Database Connection Timeout

**Symptoms:**
```
Error: Connection timeout
```

**Solutions:**
1. Verify DATABASE_URL format:
   ```
   postgresql://user:pass@host:5432/dbname
   ```
2. Check database service status (should be green)
3. Restart backend service

### Issue: Build Fails

**Symptoms:**
```
Error: Cannot find module 'xyz'
```

**Solutions:**
1. Check `package.json` has all dependencies
2. Verify Node version compatibility (needs >=18.0.0)
3. Check build logs for specific error
4. Try manual redeploy

### Issue: Migrations Fail

**Symptoms:**
```
Prisma migration failed
```

**Solutions:**
1. Check Prisma schema syntax
2. Manually run migrations via Shell:
   ```bash
   cd server
   npx prisma migrate deploy
   ```
3. Check database has correct permissions
4. Verify schema changes are committed

### Issue: Service Spins Down (Free Tier)

**Symptoms:**
- First request takes 30+ seconds
- Service shows "sleeping"

**Solutions:**
1. **Upgrade to Starter plan** ($7/month for always-on)
2. Or accept 30-50s cold start on free tier
3. Use external uptime monitor to keep it warm (not recommended)

### Issue: CORS Error

**Symptoms:**
```
Access to fetch at 'https://backend...' from origin 'https://frontend...'
has been blocked by CORS policy
```

**Solutions:**
1. Update `ALLOWED_ORIGINS` in backend env vars
2. Include full URL with protocol: `https://lmtek-frontend.onrender.com`
3. No trailing slash
4. Redeploy backend after changing
5. Check browser console for exact error message

### Getting Help

1. **Check Logs:** Service → Logs tab
2. **Render Docs:** https://render.com/docs
3. **Support:** help@render.com (or in-app chat)
4. **Community:** Render Community Forum

---

## Maintenance Tasks

### Weekly
- [ ] Review error logs for issues
- [ ] Check service metrics (CPU, memory)
- [ ] Verify backups are running

### Monthly
- [ ] Update dependencies (`npm outdated`)
- [ ] Review and rotate admin password
- [ ] Check Render billing
- [ ] Review security alerts

### Quarterly
- [ ] Audit user accounts
- [ ] Review and update CORS settings
- [ ] Database performance optimization
- [ ] Update documentation

---

## Rollback Procedure

If deployment breaks production:

### Method 1: Rollback via Dashboard

1. Go to failed service → **Deploys** tab
2. Find last successful deploy
3. Click **"⋮"** → **"Rollback to this version"**
4. Confirm rollback

### Method 2: Revert Git Commit

```bash
# Revert last commit
git revert HEAD
git push origin main

# Render auto-deploys the reverted version
```

### Method 3: Manual Redeploy

1. Go to service → **Manual Deploy**
2. Select previous commit SHA
3. Click **"Deploy"**

---

## Next Steps

After successful deployment:

1. **Test Thoroughly:**
   - Create test quotes
   - Test all component categories
   - Verify admin functions work
   - Test on mobile devices

2. **Implement Security Hardening:**
   - Follow `SECURITY_ROADMAP.md`
   - Rate limiting
   - JWT cookies
   - Input sanitization

3. **Set Up Monitoring:**
   - Configure email alerts
   - Set up error tracking (Sentry)
   - Monitor performance metrics

4. **Document Production URLs:**
   - Save URLs in password manager
   - Update internal documentation
   - Share with team

5. **Plan Backups:**
   - Test manual backup procedure
   - Verify automatic backups working
   - Document restore procedure

---

## Support & Resources

**Official Documentation:**
- Render Docs: https://render.com/docs
- Render Blueprint Guide: https://render.com/docs/blueprint-spec
- Prisma on Render: https://render.com/docs/deploy-prisma

**Project Documentation:**
- `PROJECT_CONTEXT.md` - Application overview
- `SECURITY_ROADMAP.md` - Security implementation
- `PSU_REFERENCE.md` - PSU system documentation
- `CHANGELOG.md` - Version history

**Need Help?**
- Render Support: help@render.com
- Render Community: https://community.render.com
- Project Issues: GitHub Issues on marolinik/LMTTekSrv

---

**Deployment Checklist:**

- [ ] Repository pushed to GitHub
- [ ] Render account created
- [ ] Blueprint deployed
- [ ] Environment variables configured
- [ ] Database migrations run
- [ ] CORS settings updated
- [ ] Deployment verified
- [ ] Admin password changed
- [ ] Monitoring configured
- [ ] Backups enabled
- [ ] Documentation updated
- [ ] Team notified

**Congratulations! Your LM TEK Server Configurator is now live on Render.com!** 🚀
